<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html}">
<main th:fragment="contenido">

    <section class="map-hero">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8 mx-auto text-center">
                    <div class="map-badge mb-3">
                        <i class="bi bi-pin-map-fill me-2"></i>Exploración Geográfica
                    </div>
                    <h1 class="display-5 fw-bold mb-2 animated-gradient-text">
                        Mapa Mundial de Hechos
                    </h1>
                    <p class="lead text-muted mb-4">
                        Hacé clic en un marcador para ver los detalles de un hecho histórico,
                        o hacé clic en cualquier parte del mapa para contribuir con uno nuevo.
                    </p>
                    <div class="map-instructions">
                        <div class="instruction-item">
                            <div class="instruction-icon">
                                <i class="bi bi-cursor-fill"></i>
                            </div>
                            <span>Clic en marcador = Ver detalles</span>
                        </div>
                        <div class="instruction-item">
                            <div class="instruction-icon">
                                <i class="bi bi-plus-circle-fill"></i>
                            </div>
                            <span>Clic en mapa = Contribuir</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contenedor del mapa -->
    <div class="container mb-5">
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <style>
        .map-hero{padding:80px 0 40px;background:radial-gradient(ellipse 1400px 800px at 50% -100px,rgba(102,126,234,.12) 0%,transparent 50%);position:relative;overflow:hidden}
        .map-hero::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236b5cff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");pointer-events:none}
        .map-badge{background:linear-gradient(135deg,rgba(102,126,234,.15),rgba(139,92,246,.15));color:#667eea;padding:.65rem 1.5rem;border-radius:50px;font-size:.875rem;font-weight:600;display:inline-flex;align-items:center;border:1px solid rgba(102,126,234,.2)}
        .map-instructions{display:flex;gap:2rem;justify-content:center;flex-wrap:wrap;margin-top:1.5rem}
        .instruction-item{display:flex;align-items:center;gap:.75rem;background:#fff;padding:.75rem 1.25rem;border-radius:12px;border:1px solid rgba(0,0,0,.06);box-shadow:0 2px 8px rgba(0,0,0,.05);font-size:.9rem;font-weight:500}
        .instruction-icon{width:32px;height:32px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.9rem}

        .map-container{border-radius:24px;overflow:hidden;border:1px solid rgba(0,0,0,.08);box-shadow:0 20px 60px rgba(0,0,0,.15);position:relative}
        .map-container::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea 0%,#764ba2 50%,#667eea 100%);z-index:1000;animation:shimmer 3s ease-in-out infinite}
        @keyframes shimmer{0%,100%{opacity:.6}50%{opacity:1}}
        #map{height:75vh;width:100%;min-height:500px}

        .leaflet-tooltip{background:#fff!important;border:none!important;border-radius:14px!important;padding:1rem 1.25rem!important;box-shadow:0 12px 32px rgba(0,0,0,.2)!important;font-size:.875rem!important;max-width:280px!important;line-height:1.5!important;color:#1a202c!important}
        .leaflet-tooltip::before{content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:12px;height:12px;background:#fff;transform:rotate(45deg);box-shadow:2px 2px 4px rgba(0,0,0,.1)}
        .leaflet-tooltip strong{display:block;font-size:1rem;font-weight:700;margin-bottom:.5rem;color:#667eea;border-bottom:2px solid rgba(102,126,234,.2);padding-bottom:.5rem}
        .leaflet-tooltip-text{display:block;color:#64748b;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;line-height:1.4}

        .leaflet-popup-content-wrapper{background:#fff!important;border-radius:16px!important;padding:0!important;box-shadow:0 12px 40px rgba(0,0,0,.2)!important;border:1px solid rgba(0,0,0,.08)!important}
        .leaflet-popup-content{margin:1.25rem!important;font-size:.9rem!important;line-height:1.6!important;color:#475569!important;min-width:250px!important;max-width:320px!important}
        .leaflet-popup-content strong{display:block;font-size:1.1rem;font-weight:700;color:#1a202c;margin-bottom:.75rem;padding-bottom:.75rem;border-bottom:2px solid rgba(102,126,234,.2)}
        .leaflet-popup-tip{background:#fff!important;border:1px solid rgba(0,0,0,.08)!important;box-shadow:0 2px 8px rgba(0,0,0,.1)!important}
        .leaflet-popup-close-button{font-size:1.5rem!important;color:#94a3b8!important;padding:.5rem!important}
        .leaflet-popup-close-button:hover{color:#667eea!important}

        .leaflet-marker-icon{filter:drop-shadow(0 4px 8px rgba(102,126,234,.4))!important}
        .leaflet-marker-icon:hover{filter:drop-shadow(0 6px 16px rgba(102,126,234,.6))!important}

        .leaflet-control-zoom{border:none!important;box-shadow:0 4px 12px rgba(0,0,0,.15)!important;border-radius:12px!important;overflow:hidden}
        .leaflet-control-zoom a{background:#fff!important;color:#667eea!important;border:none!important;width:36px!important;height:36px!important;line-height:36px!important;font-weight:700!important;transition:all .2s ease!important}
        .leaflet-control-zoom a:hover{background:#667eea!important;color:#fff!important}
        .leaflet-control-zoom a:first-child{border-bottom:1px solid #eee!important}

        /* Responsive */
        @media (max-width:768px){
            .map-hero{padding:60px 0 30px}
            .display-5{font-size:2rem}
            .map-instructions{flex-direction:column;align-items:center;gap:1rem}
            #map{height:60vh;min-height:400px}
            .leaflet-tooltip{max-width:220px!important;padding:.75rem 1rem!important}
            .leaflet-popup-content{min-width:200px!important;max-width:280px!important}
        }

    </style>

    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Script -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const hechos = JSON.parse(/*[[${hechosJson}]]*/ '[]');

        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const hechosConCoords = (hechos || []).filter(h =>
            h && typeof h.latitud === 'number' && typeof h.longitud === 'number'
        );

        if (hechosConCoords.length > 0) {
            const bounds = [];
            hechosConCoords.forEach(h => {
                const marker = L.marker([h.latitud, h.longitud]).addTo(map);
                const titulo = h.titulo || 'Hecho';
                const desc = h.descripcion ? String(h.descripcion) : '';

                // Limitar descripción para tooltip (máx 150 caracteres)
                const descCorta = desc.length > 150 ? desc.slice(0, 150) + '...' : desc;

                // Tooltip al hover con descripción limitada
                marker.bindTooltip(
                    `<strong>${esc(titulo)}</strong><span class="leaflet-tooltip-text">${esc(descCorta)}</span>`,
                    { direction:'top', offset:[0,-10], opacity:1 }
                );

                // Popup al click con descripción limitada
                const descPopup = desc.length > 200 ? desc.slice(0, 200) + '...' : desc;
                marker.bindPopup(`<strong>${esc(titulo)}</strong>${esc(descPopup)}`);

                // Click → detalle
                marker.on('click', () => {
                    const url = '/hechos/public/get?id_hecho=' + encodeURIComponent(h.id)
                        + (h.fuente ? ('&fuente=' + encodeURIComponent(h.fuente)) : '');
                    window.location.href = url;
                });

                bounds.push([h.latitud, h.longitud]);
            });
            map.fitBounds(bounds, { padding: [30,30] });
        } else {
            map.setView([-34.6, -58.45], 3);
        }

        // Click en mapa → redirige sólo con lat/long
        map.on('click', (e) => {
            const lat = e.latlng.lat.toFixed(6);
            const lon = e.latlng.lng.toFixed(6);
            window.location.href = `/public/contribuir?latitud=${encodeURIComponent(lat)}&longitud=${encodeURIComponent(lon)}`;
        });

        function esc(s){
            return String(s||'').replace(/[&<>"']/g, m => (
                {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
            ));
        }
        /*]]>*/
    </script>

</main>
</html>