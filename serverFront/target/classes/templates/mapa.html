<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html}">
<main th:fragment="contenido" class="container py-4">

    <!-- Encabezado -->
    <section class="text-center py-4"
             style="background: radial-gradient(1200px 600px at 50% -150px, #e8ecf6 0%, #f7f9fb 100%);
                    border-radius:12px;">
        <h2 class="fw-bold mb-1"><i class="bi bi-globe-americas me-2"></i>Mapa mundial de hechos</h2>
        <p class="text-muted mb-0">Se muestran sólo los hechos con latitud y longitud.</p>
    </section>

    <!-- Contenedor del mapa -->
    <div class="mt-4 shadow-sm border rounded-3 overflow-hidden">
        <div id="map"></div>
    </div>

    <style>
        #map {
            height: 75vh;
            width: 100%;
        }

        .leaflet-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            color: #222;
            padding: 6px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            max-width: 220px;
        }

        .leaflet-tooltip strong {
            display: block;
            margin-bottom: 3px;
        }
    </style>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Script para el mapa -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const hechos = JSON.parse(/*[[${hechosJson}]]*/ '[]');

        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const hechosConCoords = (hechos || []).filter(h =>
            h && typeof h.latitud === 'number' && typeof h.longitud === 'number'
        );

        if (hechosConCoords.length > 0) {
            const bounds = [];
            hechosConCoords.forEach(h => {
                const marker = L.marker([h.latitud, h.longitud]).addTo(map);
                const titulo = h.titulo || 'Hecho';
                const desc = h.descripcion ? String(h.descripcion).slice(0, 180) : '';

                // Tooltip que aparece al pasar el mouse
                marker.bindTooltip(
                    `<strong>${esc(titulo)}</strong>${esc(desc)}`,
                    { direction: 'top', offset: [0, -5], opacity: 0.9 }
                );

                // Popup (al hacer click)
                marker.bindPopup(`<strong>${esc(titulo)}</strong><br>${esc(desc)}`);

                // Click → ir al detalle
                marker.on('click', () => {
                    const url = '/hechos/public/get?id_hecho=' + encodeURIComponent(h.id)
                        + (h.fuente ? ('&fuente=' + encodeURIComponent(h.fuente)) : '');
                    window.location.href = url;
                });

                bounds.push([h.latitud, h.longitud]);
            });
            map.fitBounds(bounds, { padding: [30, 30] });
        } else {
            map.setView([-34.6, -58.45], 3);
        }

        function esc(s) {
            return String(s || '').replace(/[&<>"']/g, m => (
                {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
            ));
        }
        /*]]>*/
    </script>

</main>
</html>
