<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<main th:fragment="contenido" class="container py-4">

    <section class="text-center py-4"
             style="background: radial-gradient(1200px 600px at 50% -150px, #e8ecf6 0%, #f7f9fb 100%);
                  border-radius:12px;">
        <h2 class="fw-bold mb-1"><i class="bi bi-link-45deg me-2"></i>Crear Sinónimo</h2>
        <p class="text-muted mb-0">Agregá un sinónimo para categorías, países o provincias</p>
    </section>

    <div class="row justify-content-center mt-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm" style="border-radius:14px;">
                <div class="card-body p-4">

                    <form th:action="@{/gestion/sinonimos/crear}" method="post" th:object="${sinonimoForm}">
                        <input type="hidden" th:if="${_csrf != null}"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}"/>

                        <!-- Tipo -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold" for="tipo">Tipo de sinónimo *</label>
                            <select class="form-select" id="tipo" th:field="*{tipo}" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="categoria">Categoría</option>
                                <option value="pais">País</option>
                                <option value="provincia">Provincia</option>
                            </select>
                        </div>

                        <!-- ENTIDAD -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Entidad *</label>

                            <!-- Categoría -->
                            <div id="grupoCategoria" class="mb-2 d-none">
                                <select class="form-select" id="selectCategoria" name="id_entidad">
                                    <option value="">Seleccionar categoría</option>
                                    <option th:each="cat : ${categorias}"
                                            th:value="${cat.id}"
                                            th:text="${cat.categoria}">Categoria</option>
                                </select>
                            </div>

                            <!-- País (simple) -->
                            <div id="grupoPais" class="mb-2 d-none">
                                <select class="form-select" id="selectPaisSimple" name="id_entidad">
                                    <option value="">Seleccionar país</option>
                                    <option th:each="p : ${paises}"
                                            th:value="${p.id}"
                                            th:text="${p.pais}">País</option>
                                </select>
                            </div>

                            <!-- Provincia (país + provincia) -->
                            <div id="grupoProvincia" class="mb-2 d-none">
                                <!-- País para filtrar provincias -->
                                <select class="form-select mb-2" id="selectPaisParaProvincia">
                                    <option value="">Seleccionar país</option>
                                    <option th:each="p : ${paises}"
                                            th:value="${p.id}"
                                            th:text="${p.pais}">País</option>
                                </select>

                                <!-- Provincias cargadas por AJAX, se manda como id_entidad -->
                                <select class="form-select" id="selectProvincia" name="id_entidad" disabled>
                                    <option value="">Seleccionar provincia</option>
                                </select>
                            </div>

                            <div class="form-text">
                                Elegí la entidad a la que le querés agregar el sinónimo.
                            </div>
                        </div>

                        <!-- Sinónimo -->
                        <div class="mb-3" style="background:#f8f9fa;border-radius:8px;padding:15px;">
                            <label class="form-label fw-semibold" for="sinonimo">Sinónimo *</label>
                            <input type="text" class="form-control" id="sinonimo" th:field="*{sinonimo}"
                                   placeholder="Ej: Incendio Bosque" required />
                            <div class="form-text">Podés agregar más sinónimos luego desde la edición.</div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a class="btn btn-outline-secondary" th:href="@{/usuarios/perfil}">
                                <i class="bi bi-arrow-left me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-dark">
                                <i class="bi bi-check2 me-1"></i> Crear Sinónimo
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <style>.btn:hover{transform:translateY(-1px);transition:transform .08s ease}</style>
        </div>
    </div>

    <!-- JS para mostrar/ocultar selects y cargar provincias -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tipoSelect          = document.getElementById('tipo');
            const grupoCategoria      = document.getElementById('grupoCategoria');
            const grupoPais           = document.getElementById('grupoPais');
            const grupoProvincia      = document.getElementById('grupoProvincia');
            const selectPaisProv      = document.getElementById('selectPaisParaProvincia');
            const selectProvincia     = document.getElementById('selectProvincia');

            function ocultarTodos() {
                grupoCategoria.classList.add('d-none');
                grupoPais.classList.add('d-none');
                grupoProvincia.classList.add('d-none');
            }

            function actualizarSegunTipo() {
                const tipo = tipoSelect.value;
                ocultarTodos();

                // Limpio name="id_entidad" de todos por seguridad
                document.querySelectorAll('select[name="id_entidad"]').forEach(s => {
                    s.disabled = true;
                });

                if (tipo === 'categoria') {
                    grupoCategoria.classList.remove('d-none');
                    document.getElementById('selectCategoria').disabled = false;

                } else if (tipo === 'pais') {
                    grupoPais.classList.remove('d-none');
                    document.getElementById('selectPaisSimple').disabled = false;

                } else if (tipo === 'provincia') {
                    grupoProvincia.classList.remove('d-none');
                    selectProvincia.disabled = true;
                    // provincias se cargan cuando elija un país
                }
            }

            tipoSelect.addEventListener('change', actualizarSegunTipo);
            actualizarSegunTipo(); // inicial

            // Cuando elige un país en el combo de provincias
            selectPaisProv.addEventListener('change', function () {
                const idPais = this.value;

                // Reseteo provincias
                selectProvincia.innerHTML = '<option value="">Seleccionar provincia</option>';
                selectProvincia.disabled = true;

                if (!idPais) {
                    return;
                }

                // ⚠️ Cambiá la URL al endpoint real que ya tengas
                fetch('/hechos/public/provincias?paisId=' + idPais)
                    .then(r => r.json())
                    .then(data => {
                        data.forEach(pv => {
                            const opt = document.createElement('option');
                            opt.value = pv.id;
                            // Cambiá nombreProvincia por el campo real (ej: pv.nombre, pv.detalle, etc)
                            opt.textContent = pv.provincia || pv.nombre || pv.detalle || '';
                            selectProvincia.appendChild(opt);
                        });
                        selectProvincia.disabled = false;
                    })
                    .catch(err => {
                        console.error('Error cargando provincias', err);
                    });
            });
        });
    </script>

</main>
</html>
