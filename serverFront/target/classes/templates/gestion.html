<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gestión — MetaMapa</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root{ --mm-primary:#4f46e5; --mm-admin:#059669; --mm-ink:#0f172a; --mm-muted:#6b7280; --mm-card:#ffffff; }
        body{ background: radial-gradient(1200px 600px at 50% -150px,#e8ecf6 0%,#f5f7fb 45%,#ffffff 100%); }
        .navbar{ background:#ffffff; border-bottom:1px solid #eef2f7; }
        .brand-pill{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#6b5cff,#8b5cf6);
            color:#fff;display:inline-flex;align-items:center;justify-content:center;font-weight:800;margin-right:.5rem}
        .page-wrap{padding:28px 0}
        .card-elev{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 24px rgba(2,6,23,.05)}
        .nav-pills-custom .nav-link{color:#475569;border-radius:999px}
        .nav-pills-custom .nav-link.active{background:var(--mm-admin);color:#fff}
        .method-tab{background:#f8fafc;border:1px solid #e5e7eb;color:#334155;text-decoration:none;padding:12px 16px;border-radius:10px}
        .method-tab.active{background:var(--mm-admin);color:#fff;border-color:var(--mm-admin)}
        .stats-card{background:linear-gradient(135deg,var(--mm-admin),#047857);color:#fff;border-radius:16px;padding:18px;text-align:center}
        .stats-card h3{font-size:2rem;font-weight:800;margin:0}
        .category-item{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:14px}
        .delete-btn{background:#dc2626;border:none;color:#fff;border-radius:8px;padding:6px 10px}
        .delete-btn:hover{background:#b91c1c}
        .tab-content-management{display:none}
        .tab-content-management#categorias{display:block}
        /* Colores del selector */
        .color-selector{display:flex;gap:10px;flex-wrap:wrap}
        .color-option{width:46px;height:46px;border-radius:10px;border:3px solid transparent;cursor:pointer}
        .color-option[data-v="AZUL"]{background:linear-gradient(135deg,#2563eb,#3b82f6)}
        .color-option[data-v="VERDE"]{background:linear-gradient(135deg,#059669,#10b981)}
        .color-option[data-v="AMARILLO"]{background:linear-gradient(135deg,#d97706,#f59e0b)}
        .color-option[data-v="ROJO"]{background:linear-gradient(135deg,#dc2626,#ef4444)}
        .color-option[data-v="CELESTE"]{background:linear-gradient(135deg,#0ea5e9,#38bdf8)}
        .color-option[data-v="GRIS"]{background:linear-gradient(135deg,#6b7280,#9ca3af)}
        .color-option.active{border-color:#111827}
    </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
            <span class="brand-pill">M</span><span class="fw-bold">MetaMapa</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="navMain" class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto nav-pills nav-pills-custom">
                <li class="nav-item"><a class="nav-link" th:href="@{/hechos/public/get-all}"><i class="bi bi-file-text me-1"></i> Hechos</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/mapa}"><i class="bi bi-map me-1"></i> Mapa</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/colecciones/get-all}"><i class="bi bi-collection me-1"></i> Colecciones</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/contribuir}"><i class="bi bi-plus me-1"></i> Contribuir</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/solicitudes-hecho/get/pendientes}"><i class="bi bi-clipboard-check me-1"></i> Solicitudes</a></li>
                <li class="nav-item"><a class="nav-link active" th:href="@{/gestion}"><i class="bi bi-gear me-1"></i> Gestión</a></li>
            </ul>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-dark">ADMINISTRADOR</span>
                <!-- Mantengo el logout como en tu archivo -->
                <a class="btn btn-outline-secondary btn-sm" th:href="@{/logout}">
                    <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
                </a>
            </div>
        </div>
    </div>
</nav>

<section class="page-wrap">
    <div class="container">

        <div class="text-center mb-4">
            <h1 class="h3 fw-bold">
                <i class="bi bi-gear-fill me-2"></i> Gestión del sistema
            </h1>
            <div class="text-muted">Administra categorías, sinónimos y colecciones</div>
        </div>

        <!-- Stats dinámicas -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3"><div class="stats-card"><h3 th:text="${statsCategorias} ?: 0">0</h3><div>Categorías</div></div></div>
            <div class="col-6 col-md-3"><div class="stats-card"><h3 th:text="${statsSinonimos} ?: 0">0</h3><div>Sinónimos</div></div></div>
            <div class="col-6 col-md-3"><div class="stats-card"><h3 th:text="${statsColecciones} ?: 0">0</h3><div>Colecciones</div></div></div>
            <div class="col-6 col-md-3"><div class="stats-card"><h3 th:text="${statsHechos} ?: 0">0</h3><div>Hechos</div></div></div>
        </div>

        <div class="card-elev">
            <!-- Tabs -->
            <div class="d-flex flex-wrap gap-2 p-3 border-bottom">
                <a href="#categorias" class="method-tab active"> <i class="bi bi-tags me-2"></i>Categorías</a>
                <a href="#sinonimos" class="method-tab">         <i class="bi bi-link-45deg me-2"></i>Sinónimos</a>
                <a href="#colecciones" class="method-tab">       <i class="bi bi-collection me-2"></i>Colecciones</a>
            </div>

            <!-- ============= CATEGORÍAS ============= -->
            <section id="categorias" class="tab-content-management p-3">
                <div class="row g-3">
                    <!-- Nueva categoría -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header"><strong><i class="bi bi-plus-circle me-2"></i>Nueva categoría</strong></div>
                            <div class="card-body">
                                <form th:action="@{/gestion/categorias}" method="post">
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Nombre *</label>
                                        <input class="form-control" name="nombre" required minlength="2" maxlength="80">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Color</label>
                                        <input type="hidden" name="color" id="catColor" value="GRIS">
                                        <div class="color-selector" id="selectorColor">
                                            <div class="color-option active" data-v="GRIS"    title="Gris"></div>
                                            <div class="color-option"        data-v="AZUL"    title="Azul"></div>
                                            <div class="color-option"        data-v="VERDE"   title="Verde"></div>
                                            <div class="color-option"        data-v="AMARILLO" title="Amarillo"></div>
                                            <div class="color-option"        data-v="ROJO"    title="Rojo"></div>
                                            <div class="color-option"        data-v="CELESTE" title="Celeste"></div>
                                        </div>
                                    </div>
                                    <button class="btn btn-success w-100" type="submit"><i class="bi bi-check2 me-1"></i>Crear</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Listado -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong><i class="bi bi-list me-2"></i>Categorías existentes</strong>
                                <form class="d-flex gap-2" th:action="@{/gestion/categorias}" method="get">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                                        <input class="form-control" name="q" th:value="${param.q}" placeholder="Buscar…">
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm">Filtrar</button>
                                </form>
                            </div>
                            <div class="card-body">
                                <div class="category-item mb-2" th:each="cat : ${categorias}">
                                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div>
                                            <div class="fw-semibold" th:text="${cat.nombre}">Política</div>
                                            <small class="text-muted">Color: <span th:text="${cat.color}">GRIS</span></small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary-subtle text-dark" th:text="${cat.cantidadHechos} + ' hechos'">0 hechos</span>
                                            <a class="btn btn-outline-primary btn-sm" th:href="@{/gestion/categorias/{id}/editar(id=${cat.id})}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <form th:action="@{/gestion/categorias/{id}(id=${cat.id})}" method="post" class="d-inline" onsubmit="return confirm('Eliminar categoría?');">
                                                <input type="hidden" name="_method" value="delete">
                                                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                <button class="delete-btn" type="submit"><i class="bi bi-trash"></i></button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center" th:if="${#lists.isEmpty(categorias)}">
                                    <span class="text-muted">No hay categorías.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= SINÓNIMOS ============= -->
            <section id="sinonimos" class="tab-content-management p-3">
                <div class="row g-3">
                    <!-- Alta -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header"><strong><i class="bi bi-plus-circle me-2"></i>Nuevo sinónimo</strong></div>
                            <div class="card-body">
                                <form th:action="@{/gestion/sinonimos}" method="post">
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Tipo *</label>
                                        <select class="form-select" name="tipo" required>
                                            <option value="" disabled selected>Seleccionar tipo</option>
                                            <option value="categoria">Categoría</option>
                                            <option value="pais">País</option>
                                            <option value="provincia">Provincia</option>
                                            <option value="ciudad">Ciudad</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Término principal *</label>
                                        <input class="form-control" name="principal" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Variantes (separadas por coma) *</label>
                                        <input class="form-control" name="variantes" placeholder="Ej: CABA, Ciudad de Buenos Aires" required>
                                    </div>
                                    <button class="btn btn-success w-100" type="submit"><i class="bi bi-check2 me-1"></i>Crear</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Listado -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong><i class="bi bi-link-45deg me-2"></i>Sinónimos existentes</strong>
                                <form class="d-flex gap-2" th:action="@{/gestion/sinonimos}" method="get">
                                    <select class="form-select form-select-sm" style="width:160px" name="tipo">
                                        <option th:value="" th:selected="${#strings.isEmpty(param.tipo)}">Todos</option>
                                        <option th:value="categoria" th:selected="${param.tipo=='categoria'}">Categoría</option>
                                        <option th:value="pais"      th:selected="${param.tipo=='pais'}">País</option>
                                        <option th:value="provincia" th:selected="${param.tipo=='provincia'}">Provincia</option>
                                        <option th:value="ciudad"    th:selected="${param.tipo=='ciudad'}">Ciudad</option>
                                    </select>
                                    <div class="input-group" style="width:240px">
                                        <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                                        <input class="form-control" name="q" th:value="${param.q}" placeholder="Buscar…">
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm">Filtrar</button>
                                </form>
                            </div>
                            <div class="card-body">
                                <div class="category-item mb-2" th:each="s : ${sinonimos}">
                                    <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center gap-2 mb-1">
                                                <strong th:text="${s.principal}">Principal</strong>
                                                <span class="badge bg-secondary" th:if="${s.tipo=='provincia'}">Provincia</span>
                                                <span class="badge bg-primary"   th:if="${s.tipo=='pais'}">País</span>
                                                <span class="badge bg-warning text-dark" th:if="${s.tipo=='categoria'}">Categoría</span>
                                                <span class="badge bg-info text-dark"    th:if="${s.tipo=='ciudad'}">Ciudad</span>
                                            </div>
                                            <div class="small text-muted">
                                                <span class="badge text-bg-light me-1" th:each="v : ${s.variantes}" th:text="${v}">Variante</span>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <small class="text-muted" th:text="${s.usos} + ' usos'">0 usos</small>
                                            <a class="btn btn-outline-primary btn-sm" th:href="@{/gestion/sinonimos/{id}/editar(id=${s.id})}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <form th:action="@{/gestion/sinonimos/{id}(id=${s.id})}" method="post" onsubmit="return confirm('Eliminar sinónimo?')">
                                                <input type="hidden" name="_method" value="delete">
                                                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                <button class="delete-btn"><i class="bi bi-trash"></i></button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center" th:if="${#lists.isEmpty(sinonimos)}">
                                    <span class="text-muted">No hay sinónimos.</span>
                                </div>

                                <!-- Paginación opcional -->
                                <nav class="mt-3" th:if="${pageTotal != null and pageTotal > 1}">
                                    <ul class="pagination justify-content-center pagination-sm">
                                        <li class="page-item" th:classappend="${page==1} ? ' disabled'">
                                            <a class="page-link" th:href="@{/gestion/sinonimos(page=${page-1}, q=${param.q}, tipo=${param.tipo})}">&laquo;</a>
                                        </li>
                                        <li class="page-item" th:each="i : ${#numbers.sequence(1, pageTotal)}" th:classappend="${i==page} ? ' active'">
                                            <a class="page-link" th:text="${i}" th:href="@{/gestion/sinonimos(page=${i}, q=${param.q}, tipo=${param.tipo})}">1</a>
                                        </li>
                                        <li class="page-item" th:classappend="${page==pageTotal} ? ' disabled'">
                                            <a class="page-link" th:href="@{/gestion/sinonimos(page=${page+1}, q=${param.q}, tipo=${param.tipo})}">&raquo;</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ============= COLECCIONES (alta rápida) ============= -->
            <section id="colecciones" class="tab-content-management p-3">
                <div class="card">
                    <div class="card-header" style="background:#8b5cf6;color:#fff">
                        <strong><i class="bi bi-plus-circle me-2"></i>Crear nueva colección</strong>
                    </div>
                    <div class="card-body">
                        <!-- RUTA CORREGIDA: /colecciones/crear -->
                        <form th:action="@{/colecciones/crear}" method="post" th:object="${coleccionForm}">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Título *</label>
                                    <input class="form-control" th:field="*{titulo}" required minlength="3">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Algoritmo de consenso</label>
                                    <select class="form-select" th:field="*{algoritmoConsenso}">
                                        <option th:value="">— Ninguno —</option>
                                        <option th:each="alg : ${algoritmosConsenso}" th:value="${alg.codigo}" th:text="${alg.nombre}">Mayoría simple</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Descripción *</label>
                                    <textarea class="form-control" th:field="*{descripcion}" rows="3" required minlength="10"></textarea>
                                </div>

                                <div class="col-12"><hr></div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Origen</label>
                                    <select class="form-select" th:field="*{criterios.origen}">
                                        <option th:value="">Cualquiera</option>
                                        <option th:value="0">Estático</option>
                                        <option th:value="1">Dinámico</option>
                                        <option th:value="2">Proxy</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Multimedia</label>
                                    <select class="form-select" th:field="*{criterios.contenidoMultimedia}">
                                        <option th:value="">Cualquiera</option>
                                        <option th:value="1">Con multimedia</option>
                                        <option th:value="0">Sin multimedia</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Título contiene</label>
                                    <input class="form-control" th:field="*{criterios.titulo}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Descripción contiene</label>
                                    <input class="form-control" th:field="*{criterios.descripcion}">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Fecha del acontecimiento</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" th:field="*{criterios.fechaAcontecimientoInicial}">
                                        <span class="input-group-text">a</span>
                                        <input type="date" class="form-control" th:field="*{criterios.fechaAcontecimientoFinal}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Fecha de carga</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" th:field="*{criterios.fechaCargaInicial}">
                                        <span class="input-group-text">a</span>
                                        <input type="date" class="form-control" th:field="*{criterios.fechaCargaFinal}">
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-3">
                                <button class="btn btn-success"><i class="bi bi-check2 me-1"></i>Crear colección</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Tabs
    (function(){
        const tabs = document.querySelectorAll('.method-tab');
        const panels = document.querySelectorAll('.tab-content-management');
        function show(id){
            panels.forEach(p => p.style.display = (p.id===id)?'block':'none');
            tabs.forEach(t => t.classList.toggle('active', t.getAttribute('href')==='#'+id));
            if(history && history.replaceState){ history.replaceState(null,'','#'+id); }
        }
        tabs.forEach(t => t.addEventListener('click', e => { e.preventDefault(); show(t.getAttribute('href').substring(1)); }));
        const initial = (location.hash || '#categorias').substring(1);
        if(document.getElementById(initial)) show(initial); else show('categorias');
    })();

    // Selector de color simple
    (function(){
        const cont = document.getElementById('selectorColor');
        if(!cont) return;
        const hidden = document.getElementById('catColor');
        cont.querySelectorAll('.color-option').forEach(el=>{
            el.addEventListener('click', ()=>{
                cont.querySelectorAll('.color-option').forEach(o=>o.classList.remove('active'));
                el.classList.add('active');
                hidden.value = el.getAttribute('data-v');
            });
        });
    })();
</script>
</body>
</html>
