<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<main th:fragment="contenido">

    <!-- Hero Header -->
    <section class="requests-hero">
        <div class="container">
            <div class="row align-items-center justify-content-between">
                <div class="col-lg-7">
                    <div class="requests-badge mb-3">
                        <i class="bi bi-clipboard-check me-2"></i>Panel de Administración
                    </div>
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="bi bi-file-earmark-text me-2"></i>Solicitudes Pendientes
                    </h1>
                    <p class="lead text-muted mb-0">
                        Revisá y gestioná las solicitudes de contribución de la comunidad
                    </p>
                </div>
                <div class="col-lg-auto">
                    <div class="counter-badge">
                        <div class="counter-number" th:text="${solicitudes != null ? solicitudes.size() : 0}">0</div>
                        <div class="counter-label">Pendientes</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container pb-5">
        <!-- Estado vacío -->
        <div th:if="${solicitudes == null or #lists.isEmpty(solicitudes)}" class="empty-state-box mt-4">
            <div class="empty-illustration">
                <i class="bi bi-check-circle"></i>
            </div>
            <h3 class="mb-2">¡Todo al día!</h3>
            <p class="text-muted mb-4">
                No hay solicitudes pendientes de revisión. Excelente trabajo manteniendo la plataforma actualizada.
            </p>
            <a th:href="@{/hechos/public/get-all}" class="btn btn-primary btn-lg">
                <i class="bi bi-compass me-2"></i>Explorar hechos
            </a>
        </div>

        <!-- Lista de solicitudes -->
        <div class="requests-list mt-4"
             th:if="${solicitudes != null and !#lists.isEmpty(solicitudes)}">

            <article class="request-card"
                     th:each="s : ${solicitudes}"
                     th:id="${'sol-' + s.id}"
                     th:with="
                        esSubir=${s.tipo} == 'SUBIR',
                        esEliminar=${s.tipo} == 'ELIMINAR',
                        actionUrl=${esSubir} ? '/solicitudes-hecho/evaluar/subir'
                                 : (${esEliminar} ? '/solicitudes-hecho/evaluar/eliminar'
                                                  : '/solicitudes-hecho/evaluar/modificar')
                     ">

                <div class="request-content" th:if="${s.hechoId != null}"
                     th:href="@{/hechos/public/get(id_hecho=${s.hechoId}, fuente='DINAMICA')}">
                    <div class="request-header">
                        <span class="request-type-badge"
                              th:classappend="${esSubir} ? 'badge-subir' : (${esEliminar} ? 'badge-eliminar' : 'badge-modificar')"
                              th:text="${s.tipo}">SUBIR</span>
                        <span class="request-date">
                            <i class="bi bi-calendar3 me-1"></i>
                            <span th:text="${s.fecha}">2025-11-05</span>
                        </span>
                    </div>

                    <h5 class="request-title">
                        Solicitud de <span th:text="${#strings.toLowerCase(s.tipo)}">subir</span>
                    </h5>

                    <div class="request-user">
                        <i class="bi bi-person-circle me-2"></i>
                        <span th:text="${s.username}">usuario</span>
                    </div>

                    <div class="request-justification" th:if="${s.justificacion != null}">
                        <div class="justification-label">
                            <i class="bi bi-chat-left-text me-1"></i>Justificación
                        </div>
                        <div class="justification-text" th:text="${#strings.abbreviate(s.justificacion, 200)}">—</div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="request-actions">
                    <form method="post" th:action="@{${actionUrl}}">
                        <input type="hidden" name="id_solicitud" th:value="${s.id}">
                        <input type="hidden" name="respuesta" value="true">
                        <input type="hidden" th:if="${_csrf != null}"
                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button class="btn btn-accept" type="submit">
                            <i class="bi bi-check-circle me-1"></i>Aceptar
                        </button>
                    </form>

                    <button class="btn btn-reject"
                            data-bs-toggle="modal" data-bs-target="#modalRechazo"
                            th:attr="data-id=${s.id}, data-tipo=${s.tipo}, data-action=${actionUrl}">
                        <i class="bi bi-x-circle me-1"></i>Rechazar
                    </button>
                </div>
            </article>

        </div>
    </div>

    <!-- MODAL RECHAZO -->
    <div class="modal fade" id="modalRechazo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <form class="modal-content border-0"
                  id="formRechazo"
                  th:object="${solicitudHechoEvaluarInputDTO}"
                  method="post"
                  style="border-radius:20px;overflow:hidden">

                <div class="modal-header"
                     style="background:linear-gradient(135deg,#fee2e2,#fecaca);border:none;padding:2rem">
                    <h5 class="modal-title fw-bold" style="color:#991b1b">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Rechazar solicitud de <span id="rechazoTipo"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" style="padding:2rem">
                    <label class="form-label fw-semibold mb-2">Motivo del rechazo</label>
                    <textarea class="form-control"
                              th:field="*{mensaje}"
                              id="rechazoMensaje"
                              rows="4"
                              maxlength="300"
                              placeholder="Explicá brevemente por qué se rechaza esta solicitud..."
                              style="border-radius:12px;border:1px solid #e9ecef;background:#f8f9ff"
                              required></textarea>
                    <div class="form-text text-end mt-2">
                        <i class="bi bi-info-circle me-1"></i>Máximo 300 caracteres
                    </div>
                </div>

                <input type="hidden" th:field="*{id_solicitud}" id="rechazoId"/>
                <input type="hidden" th:field="*{respuesta}" value="false"/>
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="modal-footer" style="border:none;padding:1.5rem 2rem 2rem">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius:12px">
                        Cancelar
                    </button>
                    <button class="btn btn-danger" type="submit"
                            style="border-radius:12px;padding:.75rem 1.5rem">
                        <i class="bi bi-x-circle me-1"></i>Confirmar rechazo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('modalRechazo');
        modal.addEventListener('show.bs.modal', (ev) => {
            const btn = ev.relatedTarget;
            const id = btn.getAttribute('data-id');
            const tipo = btn.getAttribute('data-tipo');
            const action = btn.getAttribute('data-action');
            document.getElementById('rechazoTipo').textContent = tipo;
            document.getElementById('rechazoId').value = id;
            document.getElementById('formRechazo').action = action;
        });
    </script>

</main>
</html>
