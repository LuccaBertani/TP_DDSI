<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa — MetaMapa</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>

    <style>
        :root { --primary-color:#4f46e5; }
        .nav-pills-custom .nav-link.active{ background-color:var(--primary-color); color:#fff }
        .map-container{ background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1) }
        #map{ height:600px;width:100% }
        .fact-list-item{ padding:12px;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:.2s }
        .fact-list-item:hover{ background:#f8f9fa }
        .fact-list-item.selected{ background:#e7f3ff;border-left:3px solid var(--primary-color) }
        .custom-marker{ width:30px;height:30px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.3);
          display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;cursor:pointer }
        .leaflet-popup-content-wrapper{ border-radius:8px }
        @media (max-width:768px){ #map{height:420px} .map-sidebar{margin-top:20px} }
    </style>
</head>
<body>

<!-- Header -->
<header class="bg-white border-bottom py-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a th:href="@{/'/'}" class="text-decoration-none text-dark d-flex align-items-center">
            <div class="logo-icon me-2" style="width:40px;height:40px;background:#4f46e5;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">M</div>
            <span class="fs-4 fw-bold">MetaMapa</span>
            <span class="text-muted ms-2 d-none d-md-inline">Panel de Control</span>
        </a>
        <div class="text-end">
            <form th:action="@{/logout}" method="post" th:if="${estaLogueado}">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-box-arrow-right me-1"></i>Cerrar sesión</button>
            </form>
        </div>
    </div>
</header>

<!-- Nav -->
<nav class="bg-white border-bottom">
    <div class="container-fluid py-3">
        <ul class="nav nav-pills nav-pills-custom justify-content-center">
            <li class="nav-item"><a class="nav-link" th:href="@{/hechos}"><i class="bi bi-file-text me-1"></i> Hechos</a></li>
            <li class="nav-item"><a class="nav-link active" th:href="@{/mapa}"><i class="bi bi-map me-1"></i> Mapa</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/colecciones}"><i class="bi bi-collection me-1"></i> Colecciones</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/contribuir}"><i class="bi bi-plus me-1"></i> Contribuir</a></li>
            <li class="nav-item" th:if="${isAdmin}"><a class="nav-link" th:href="@{/solicitudes}"><i class="bi bi-clipboard-check me-1"></i> Solicitudes</a></li>
            <li class="nav-item" th:if="${isAdmin}"><a class="nav-link" th:href="@{/gestion}"><i class="bi bi-gear me-1"></i> Gestión</a></li>
        </ul>
    </div>
</nav>

<main class="container-fluid py-4">
    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar en el mapa…" style="border-left:none">
            </div>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="categoryFilter">
                <option value="">Todas las categorías</option>
                <option th:each="cat : ${categorias}" th:value="${cat.codigo}" th:text="${cat.nombre}">Categoría</option>
            </select>
        </div>
    </div>

    <!-- Mapa -->
    <div class="map-container">
        <div class="bg-light border-bottom p-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-globe text-primary fs-2 me-3"></i>
                <div>
                    <h3 class="mb-1">Mapa mundial de hechos</h3>
                    <p class="text-muted mb-0">Hacé clic en los marcadores para ver detalles rápidos</p>
                </div>
            </div>
        </div>

        <div class="row g-0">
            <div class="col-lg-8"><div id="map"></div></div>
            <div class="col-lg-4 border-start bg-white map-sidebar">
                <div class="p-4">
                    <!-- Estado por defecto -->
                    <div id="defaultView" class="text-center py-4 mb-4 bg-light rounded">
                        <i class="bi bi-bullseye text-muted" style="font-size:3rem"></i>
                        <h5 class="mt-3 mb-2">Seleccioná un hecho</h5>
                        <p class="text-muted small mb-0">Tocá un marcador para ver su información</p>
                    </div>

                    <!-- Detalle seleccionado -->
                    <div id="factDetail" class="d-none">
                        <div class="mb-3">
                            <button class="btn btn-sm btn-outline-secondary mb-3" onclick="clearSelection()">
                                <i class="bi bi-arrow-left me-1"></i>Volver
                            </button>
                            <h5 id="factTitle" class="fw-bold"></h5>
                            <span id="factCategory" class="badge mb-3"></span>
                        </div>
                        <p id="factDescription" class="text-muted mb-3"></p>
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-geo-alt text-muted me-2"></i><span id="factLocation" class="small"></span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-calendar text-muted me-2"></i><span id="factDate" class="small"></span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-folder2 text-muted me-2"></i><span id="factMedia" class="small text-warning"></span>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <a class="btn btn-primary btn-sm" id="factViewLink"><i class="bi bi-eye me-1"></i>Ver detalle</a>
                            <a class="btn btn-outline-danger btn-sm" id="factReportLink"><i class="bi bi-exclamation-triangle me-1"></i>Reportar</a>
                        </div>
                    </div>

                    <!-- Lista -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">Eventos en el mapa</h6>
                            <span class="badge bg-primary" id="eventCount">0 eventos</span>
                        </div>
                        <div class="border rounded" id="factsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats simples -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm"><div class="card-body text-center">
                <i class="bi bi-pin-map text-primary fs-1"></i>
                <h5 class="mt-2" id="statsEvents">0</h5>
                <p class="text-muted mb-0 small">Eventos mostrados</p>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm"><div class="card-body text-center">
                <i class="bi bi-globe text-success fs-1"></i>
                <h5 class="mt-2" id="statsCountries">0</h5>
                <p class="text-muted mb-0 small">Países representados</p>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm"><div class="card-body text-center">
                <i class="bi bi-calendar-range text-warning fs-1"></i>
                <h5 class="mt-2" th:text="${rangoAnios} ?: '—'">—</h5>
                <p class="text-muted mb-0 small">Años de historia</p>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm"><div class="card-body text-center">
                <i class="bi bi-eye text-info fs-1"></i>
                <h5 class="mt-2" th:text="${visitasHoy} ?: 0">0</h5>
                <p class="text-muted mb-0 small">Visualizaciones hoy</p>
            </div></div>
        </div>
    </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<!-- JS con Thymeleaf inline para pasar datos -->
<script th:inline="javascript">
    /*<![CDATA[*/
      // Hechos provistos por el backend (lista de DTOs con: id,titulo,categoria,descripcion,ubicacion,fechaAcontecimiento,latitud,longitud,archivosCount)
      const hechos = /*[[${hechos}]]*/ [];
      // Opcional: mapeo de categorías a colores (Bootstrap + hex para popup)
      const catToBootstrap = /*[[${catToBootstrap}]]*/ {"politica":"primary","exploracion":"success","guerra":"danger","independencia":"warning","cientifica":"secondary"};
      const catToHex = /*[[${catToHex}]]*/ {"politica":"#4f46e5","exploracion":"#059669","guerra":"#dc2626","independencia":"#f59e0b","cientifica":"#7c3aed"};

      let map, markers = [], selectedId = null;

      function initMap(){
        map = L.map('map').setView([-20,-60], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
          attribution:'© OpenStreetMap contributors'
        }).addTo(map);

        addMarkers(hechos);
        renderList(hechos);
        updateStats(hechos);
      }

      function addMarkers(list){
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        list.forEach(h => {
          if(h.latitud == null || h.longitud == null) return;
          const cls = 'custom-marker';
          const html = `<div class="${cls}" style="background:${catToHex[h.categoria]||'#4f46e5'}">${(h.titulo||'?').substring(0,1).toUpperCase()}</div>`;
          const marker = L.marker([h.latitud, h.longitud], { icon: L.divIcon({className:'', html, iconSize:[30,30], iconAnchor:[15,15]}) })
            .addTo(map)
            .bindPopup(popupFor(h))
            .on('click', () => selectFact(h.id));
          markers.push(marker);
        });

        document.getElementById('eventCount').textContent = `${list.length} eventos`;
        document.getElementById('statsEvents').textContent = list.length;
      }

      function popupFor(h){
        const hex = catToHex[h.categoria] || '#4f46e5';
        const fechaTxt = h.fechaAcontecimiento ? new Date(h.fechaAcontecimiento).toLocaleDateString() : '—';
        return `
          <div class="popup-content">
            <h6 style="color:${hex}">${escapeHtml(h.titulo||'')}</h6>
            <span class="badge" style="background:${hex};color:#fff">${escapeHtml(cap(h.categoria||'—'))}</span>
            <p class="small mt-2 mb-2">${escapeHtml(h.descripcion||'')}</p>
            <div class="small text-muted">
              <div><i class="bi bi-geo-alt me-1"></i>${escapeHtml(h.ubicacion||'—')}</div>
              <div><i class="bi bi-calendar me-1"></i>${fechaTxt}</div>
            </div>
          </div>`;
      }

      function selectFact(id){
        selectedId = id;
        const h = hechos.find(x => x.id === id);
        if(!h) return;

        document.getElementById('defaultView').classList.add('d-none');
        document.getElementById('factDetail').classList.remove('d-none');

        document.getElementById('factTitle').textContent = h.titulo || '';
        document.getElementById('factDescription').textContent = h.descripcion || '';
        document.getElementById('factLocation').textContent = h.ubicacion || '—';
        document.getElementById('factDate').textContent = h.fechaAcontecimiento ? new Date(h.fechaAcontecimiento).toLocaleDateString() : '—';
        document.getElementById('factMedia').textContent = (h.archivosCount||0) + ' archivos multimedia';

        const catBadge = document.getElementById('factCategory');
        catBadge.textContent = cap(h.categoria || '—');
        catBadge.className = 'badge mb-3 bg-' + (catToBootstrap[h.categoria] || 'secondary');

        document.getElementById('factViewLink').setAttribute('href', `/hechos/${h.id}`);
        document.getElementById('factReportLink').setAttribute('href', `/hechos/${h.id}/reportar`);

        highlightSelected();
        if(h.latitud != null && h.longitud != null){ map.setView([h.latitud,h.longitud], 6); }
      }

      function clearSelection(){
        selectedId = null;
        document.getElementById('defaultView').classList.remove('d-none');
        document.getElementById('factDetail').classList.add('d-none');
        highlightSelected();
        map.setView([-20,-60], 3);
      }

      function renderList(list){
        const box = document.getElementById('factsList');
        box.innerHTML = '';
        list.forEach(h => {
          const badge = catToBootstrap[h.categoria] || 'secondary';
          const fechaTxt = h.fechaAcontecimiento ? new Date(h.fechaAcontecimiento).toLocaleDateString() : '—';
          const el = document.createElement('div');
          el.className = 'fact-list-item';
          el.addEventListener('click', () => selectFact(h.id));
          el.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold small">${escapeHtml(h.titulo||'')}</div>
                <div class="text-muted small"><i class="bi bi-geo-alt me-1"></i>${escapeHtml(h.ubicacion||'—')}</div>
                <div class="text-muted small"><i class="bi bi-calendar me-1"></i>${fechaTxt}</div>
              </div>
              <span class="badge bg-${badge} text-white">${escapeHtml(cap(h.categoria||'—'))}</span>
            </div>`;
          box.appendChild(el);
        });
        highlightSelected();
      }

      function highlightSelected(){
        const items = document.querySelectorAll('.fact-list-item');
        items.forEach((el, idx) => {
          const h = hechos[idx];
          el.classList.toggle('selected', !!h && h.id === selectedId);
        });
      }

      function filterByCategory(){
        const v = document.getElementById('categoryFilter').value;
        const filtered = v ? hechos.filter(h => (h.categoria||'') === v) : hechos.slice();
        addMarkers(filtered);
        renderList(filtered);
        updateStats(filtered);
      }

      function searchFacts(){
        const q = document.getElementById('searchInput').value.toLowerCase();
        const v = document.getElementById('categoryFilter').value;
        let filtered = hechos.slice();
        if(v){ filtered = filtered.filter(h => (h.categoria||'') === v); }
        if(q){
          filtered = filtered.filter(h =>
            (h.titulo||'').toLowerCase().includes(q) ||
            (h.descripcion||'').toLowerCase().includes(q) ||
            (h.ubicacion||'').toLowerCase().includes(q)
          );
        }
        addMarkers(filtered);
        renderList(filtered);
        updateStats(filtered);
      }

      function updateStats(list){
        document.getElementById('statsEvents').textContent = list.length;
        const countries = new Set(list.map(h => (h.ubicacion||'').split(',').pop()?.trim()).filter(Boolean));
        document.getElementById('statsCountries').textContent = countries.size;
      }

      // Helpers
      function cap(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1); }
      function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      // Listeners
      document.addEventListener('DOMContentLoaded', initMap);
      document.getElementById('categoryFilter').addEventListener('change', filterByCategory);
      document.getElementById('searchInput').addEventListener('input', searchFacts);
    /*]]>*/
</script>
</body>
</html>
