<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<main th:fragment="contenido" class="container py-4">

    <!-- Encabezado -->
    <section class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h5 m-0">
            Solicitudes pendientes:
            <span th:text="${solicitudes != null ? solicitudes.size() : 0}">0</span>
        </h1>
    </section>

    <!-- Estado vacío -->
    <div class="card p-5 text-center text-muted"
         th:if="${solicitudes == null or #lists.isEmpty(solicitudes)}">
        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
        No hay solicitudes por ahora.
    </div>

    <!-- Lista -->
    <div class="d-flex flex-column gap-3"
         th:if="${solicitudes != null and !#lists.isEmpty(solicitudes)}">

        <article class="card p-3 d-flex align-items-start justify-content-between gap-3"
                 th:each="s : ${solicitudes}"
                 th:id="${'sol-'+s.id}"
                 th:with="
            esSubir=${s.tipo} == 'SUBIR',
            esEliminar=${s.tipo} == 'ELIMINAR',
            actionUrl=${esSubir} ? @{/solicitudes-hecho/evaluar/subir}
                     : (${esEliminar} ? @{/solicitudes-hecho/evaluar/eliminar}
                                      : @{/solicitudes-hecho/evaluar/modificar})
         ">

            <!-- Izquierda: link al hecho (solo si hay hechoId) -->
            <a class="flex-grow-1 text-decoration-none"
               th:if="${s.hechoId != null}"
               th:href="@{/hechos/public/get(id_hecho=${s.hechoId}, fuente='DINAMICA')}">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="badge text-bg-secondary" th:text="${s.tipo}">SUBIR</span>
                    <small class="text-muted" th:text="${s.fecha}">2025-11-05</small>
                </div>
                <h2 class="h6 m-0">Solicitud de <span th:text="${s.tipo}">SUBIR</span></h2>
                <div class="text-muted small mt-1">
                    Usuario: <span th:text="${s.username}">usuario</span>
                </div>
                <div class="mt-2" th:if="${s.justificacion != null}">
                    <div class="text-muted small">Justificación:</div>
                    <div th:text="${#strings.abbreviate(s.justificacion, 200)}">—</div>
                </div>
            </a>

            <!-- Si no hay hechoId, muestro bloque no clickeable -->
            <div class="flex-grow-1 text-muted" th:if="${s.hechoId == null}">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="badge text-bg-secondary" th:text="${s.tipo}">SUBIR</span>
                    <small class="text-muted" th:text="${s.fecha}">2025-11-05</small>
                </div>
                <h2 class="h6 m-0">Solicitud de <span th:text="${s.tipo}">SUBIR</span></h2>
                <div class="text-muted small mt-1">
                    Usuario: <span th:text="${s.username}">usuario</span> — (sin Hecho asociado)
                </div>
                <div class="mt-2" th:if="${s.justificacion != null}">
                    <div class="text-muted small">Justificación:</div>
                    <div th:text="${#strings.abbreviate(s.justificacion, 200)}">—</div>
                </div>
            </div>

            <!-- Derecha: acciones -->
            <div class="d-flex flex-column gap-2 align-self-center">
                <!-- ACEPTAR: usa actionUrl ya resuelta (SUBIR/ELIMINAR/MODIFICAR) -->
                <form method="post" th:action="${actionUrl}">
                    <input type="hidden" name="id_solicitud" th:value="${s.id}">
                    <input type="hidden" name="respuesta" value="true">
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="btn btn-success btn-sm px-4" type="submit">Aceptar</button>
                </form>

                <!-- RECHAZAR: data-action SIEMPRE presente (incluye MODIFICAR) -->
                <button class="btn btn-danger btn-sm px-4"
                        data-bs-toggle="modal" data-bs-target="#modalRechazo"
                        th:attr="data-id=${s.id}, data-tipo=${s.tipo}, data-action=${actionUrl}">
                    Rechazar
                </button>
            </div>
        </article>

    </div>

    <!-- MODAL RECHAZO -->
    <div class="modal fade" id="modalRechazo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" id="formRechazo" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        Rechazar solicitud de <span id="rechazoTipo"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <label class="form-label fw-semibold">Motivo</label>
                    <textarea class="form-control" name="mensaje" id="rechazoMensaje"
                              rows="4" maxlength="300"
                              placeholder="Explicá brevemente el motivo..." required></textarea>
                    <div class="form-text text-end">máx. 300 caracteres</div>
                </div>

                <input type="hidden" name="id_solicitud" id="rechazoId"/>
                <input type="hidden" name="respuesta" value="false"/>
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-danger" type="submit">
                        <i class="bi bi-x-circle me-1"></i> Rechazar solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Modal rechazo: setea acción, tipo e id
        const modal = document.getElementById('modalRechazo');
        modal.addEventListener('show.bs.modal', (ev) => {
            const btn = ev.relatedTarget;
            const id = btn.getAttribute('data-id');
            const tipo = btn.getAttribute('data-tipo');
            const action = btn.getAttribute('data-action');
            document.getElementById('rechazoTipo').textContent = tipo;
            document.getElementById('rechazoId').value = id;
            document.getElementById('formRechazo').action = action;
            document.getElementById('rechazoMensaje').value = '';
        });
    </script>

    <style>
        body { background:#f9fafb; }
        .card { border:1px solid #e5e7eb; border-radius:12px; }
        .btn-success { background:#16a34a; border:none; }
        .btn-success:hover { background:#15803d; }
        .btn-danger { background:#dc2626; border:none; }
        .btn-danger:hover { background:#b91c1c; }
    </style>

</main>
</html>
