<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<main th:fragment="contenido" class="container py-4">

<div class="container page-container">
    <div class="text-center mb-4">
        <h1 class="fw-bold">
            <i class="bi bi-plus-circle me-2"></i> Crear nueva colección
        </h1>
        <p class="text-muted">Definí los criterios para tu colección de hechos históricos</p>
    </div>

    <div class="card-elev p-4">
        <!-- ====== Formulario CREAR COLECCIÓN ====== -->
        <form id="crearColeccionForm"
              class="card mb-4"
              th:object="${coleccionForm}"
              th:action="@{/colecciones/crear}"
              method="post"
              th:attr="data-refresh-url=@{/colecciones/crear}">

            <div class="card-body row g-3">
                <!-- CSRF -->
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Título -->
                <div class="col-12">
                    <label class="form-label fw-semibold" for="titulo">Título *</label>
                    <input class="form-control" id="titulo" th:field="*{titulo}" required minlength="3" placeholder="Título de la colección">
                </div>

                <!-- Descripción -->
                <div class="col-12">
                    <label class="form-label fw-semibold" for="descripcion">Descripción *</label>
                    <textarea class="form-control" id="descripcion" th:field="*{descripcion}" rows="3" required minlength="10" placeholder="Breve descripción"></textarea>
                </div>

                <!-- Algoritmo de consenso -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold" for="algoritmoConsenso">Algoritmo de consenso</label>
                    <select class="form-select" id="algoritmoConsenso" th:field="*{algoritmoConsenso}">
                        <option value="">— Ninguno —</option>
                        <option value="MAYORIA_ABSOLUTA">Mayoría absoluta</option>
                        <option value="MAYORIA_SIMPLE">Mayoría simple</option>
                        <option value="MULTIPLES_MENCIONES">Múltiples menciones</option>
                    </select>
                </div>

                <div class="col-12"><hr></div>
                <div class="col-12"><h5 class="fw-bold mt-1 mb-2">Criterios de filtrado (opcional)</h5></div>

                <!-- Título contiene -->
                <div class="col-md-6">
                    <label class="form-label" for="criterios_titulo">Título contiene</label>
                    <input class="form-control" id="criterios_titulo" th:field="*{criterios.titulo}" placeholder="Texto a buscar en el título">
                </div>

                <!-- Descripción contiene -->
                <div class="col-md-6">
                    <label class="form-label" for="criterios_descripcion">Descripción contiene</label>
                    <input class="form-control" id="criterios_descripcion" th:field="*{criterios.descripcion}" placeholder="Texto a buscar en la descripción">
                </div>

                <!-- Categorías (multiselección) -->
                <div class="col-md-6" th:if="${categorias != null}">
                    <label class="form-label" for="criterios_categoriaId">Categorías</label>
                    <select class="form-select js-choices" id="criterios_categoriaId" th:field="*{criterios.categoriaId}" multiple>
                        <option th:each="c : ${categorias}" th:value="${c.id}" th:text="${c.categoria}">Categoría</option>
                    </select>
                    <small class="text-muted">Podés elegir varias y buscarlas por nombre.</small>
                </div>

                <!-- Contenido multimedia -->
                <div class="col-md-6">
                    <label class="form-label" for="criterios_contenidoMultimedia">Contenido multimedia</label>
                    <select class="form-select js-choices" id="criterios_contenidoMultimedia" th:field="*{criterios.contenidoMultimedia}" multiple>
                        <option th:value="0">TEXTO</option>
                        <option th:value="1">IMAGEN</option>
                        <option th:value="2">AUDIO</option>
                        <option th:value="3">VIDEO</option>
                    </select>
                    <small class="text-muted">Multiselección con búsqueda.</small>
                </div>

                <!-- País (multiselección) -->
                <div class="col-md-6" th:if="${paises != null}">
                    <label class="form-label" for="criterios_paisId">País</label>
                    <select class="form-select js-choices" id="criterios_paisId" th:field="*{criterios.paisId}" multiple>
                        <option th:each="p : ${paises}" th:value="${p.id}" th:text="${p.pais}">País</option>
                    </select>
                    <small class="text-muted d-block">Al cambiar, se recargará la página conservando los datos.</small>
                </div>

                <!-- Provincia dependiente de País (multiselección) -->
                <div class="col-md-6">
                    <label class="form-label" for="criterios_provinciaId">Provincia</label>
                    <select class="form-select js-choices" id="criterios_provinciaId" th:field="*{criterios.provinciaId}" multiple
                            th:disabled="${provincias == null}">
                        <option th:each="pr : ${provincias}" th:value="${pr.id}" th:text="${pr.provincia}"
                                th:selected="${coleccionForm.criterios != null && coleccionForm.criterios.provinciaId != null && coleccionForm.criterios.provinciaId.contains(pr.id)}">
                            Provincia
                        </option>
                    </select>
                    <small class="text-muted d-block">Se habilita y completa según los países seleccionados.</small>
                </div>

                <!-- Fechas del acontecimiento -->
                <div class="col-md-6">
                    <label class="form-label">Fecha del acontecimiento</label>
                    <div class="input-group">
                        <input type="date" class="form-control" th:field="*{criterios.fechaAcontecimientoInicial}">
                        <span class="input-group-text">a</span>
                        <input type="date" class="form-control" th:field="*{criterios.fechaAcontecimientoFinal}">
                    </div>
                </div>

                <!-- Fechas de carga -->
                <div class="col-md-6">
                    <label class="form-label">Fecha de carga</label>
                    <div class="input-group">
                        <input type="date" class="form-control" th:field="*{criterios.fechaCargaInicial}">
                        <span class="input-group-text">a</span>
                        <input type="date" class="form-control" th:field="*{criterios.fechaCargaFinal}">
                    </div>
                </div>

                <!-- Acciones -->
                <div class="col-12 d-flex justify-content-end mt-2">
                    <a class="btn btn-outline-secondary me-2" th:href="@{/colecciones/public/get-all}">
                        <i class="bi bi-arrow-left me-1"></i> Cancelar
                    </a>
                    <button class="btn btn-success" type="submit">
                        <i class="bi bi-check2 me-1"></i> Crear colección
                    </button>
                </div>
            </div>
        </form>

        <style>
            body {
                background: radial-gradient(1200px 600px at 50% -150px, #e8ecf6 0%, #f5f7fb 45%, #ffffff 100%);
            }
            .page-container {
                max-width: 960px;
                margin: 40px auto;
            }
            .card-elev {
                background: #fff;
                border: 1px solid #e5e7eb;
                border-radius: 16px;
                box-shadow: 0 10px 24px rgba(2,6,23,.05);
            }
        </style>

        <!-- ====== JS: Bootstrap + Choices ====== -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

        <script>
            (function() {
                // Inicializar Choices
                const choicesInstances = [];
                document.querySelectorAll('.js-choices').forEach(el => {
                    const inst = new Choices(el, {
                        removeItemButton: true,
                        searchEnabled: true,
                        searchPlaceholderValue: 'Buscar…',
                        itemSelectText: '',
                        shouldSort: false
                    });
                    choicesInstances.push(inst);
                });

                const form = document.getElementById('crearColeccionForm');
                const paisSelect = document.getElementById('criterios_paisId');
                const provinciaSelect = document.getElementById('criterios_provinciaId');

                const getChoices = nativeSelect =>
                    choicesInstances.find(c => c.passedElement.element === nativeSelect);

                const setProvinciasEnabled = enabled => {
                    const c = getChoices(provinciaSelect);
                    provinciaSelect.disabled = !enabled;
                    if (c) {
                        c.disable();
                        if (enabled) c.enable();
                    }
                };

                // Si no hay país seleccionado y no hay provincias, deshabilitar provincias
                const hasPaisInicial =
                    paisSelect && Array.from(paisSelect.options).some(o => o.selected);
                if (!hasPaisInicial && (!provinciaSelect.options || provinciaSelect.options.length === 0)) {
                    setProvinciasEnabled(false);
                }

                // Recarga preservando estado del formulario
                function refreshWithCurrentState() {
                    const refreshUrl = form.getAttribute('data-refresh-url') || window.location.pathname;
                    const params = new URLSearchParams();

                    function appendAll(name, values) {
                        values.forEach(v => params.append(name, v));
                    }

                    Array.from(form.elements).forEach(el => {
                        if (!el.name || el.disabled) return;

                        // Los nombres generados por th:field en objeto anidado
                        // p.ej. criterios.categoriaId, criterios.paisId, etc.
                        if (el.tagName === 'SELECT' && el.multiple) {
                            const selected = Array.from(el.selectedOptions).map(o => o.value).filter(Boolean);
                            if (selected.length) appendAll(el.name, selected);
                            return;
                        }

                        if (el.type === 'checkbox') {
                            params.set(el.name, el.checked ? 'true' : 'false');
                            return;
                        }

                        if (el.type === 'radio') {
                            if (el.checked) params.set(el.name, el.value);
                            return;
                        }

                        if (el.value !== null && el.value !== undefined && el.value !== '') {
                            params.set(el.name, el.value);
                        }
                    });

                    const url = refreshUrl + (params.toString() ? ('?' + params.toString()) : '');
                    window.location.assign(url);
                }

                // Cuando cambia País: habilitar provincias y recargar manteniendo estado
                paisSelect?.addEventListener('change', () => {
                    setProvinciasEnabled(true);
                    refreshWithCurrentState();
                });
            })();
        </script>


    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</main>
</html>
