<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">

<main th:fragment="contenido">

    <section class="import-hero">
        <div class="container">
            <div class="row align-items-center justify-content-center">
                <div class="col-lg-8 text-center">
                    <div class="contribute-badge mb-3">
                        <i class="bi bi-cloud-arrow-up me-2"></i>Importación Masiva
                    </div>
                    <h1 class="display-5 fw-bold mb-2 animated-gradient-text">
                        Importar Hechos
                    </h1>
                    <p class="lead text-muted mb-0">
                        Cargá múltiples hechos históricos desde un archivo CSV de manera rápida y eficiente
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-xl-8">
                <form id="importForm" method="POST" enctype="multipart/form-data" class="mt-4" th:action="@{/hechos/importar}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <div class="import-card mb-4">
                        <div class="import-card-header">
                            <div class="import-card-icon">
                                <i class="bi bi-tag-fill"></i>
                            </div>
                            <h5 class="mb-0">Información de la Fuente</h5>
                        </div>
                        <div class="import-card-body">
                            <label for="inputFuente" class="form-label-import">
                                <i class="bi bi-bookmark me-2"></i>Nombre de la fuente
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control-import" id="inputFuente"
                                   required placeholder="Ej: Infobae, Wikipedia, Archivo Nacional...">
                            <small class="form-text-import">
                                <i class="bi bi-info-circle me-1"></i>Identificá la procedencia de los datos para mantener la trazabilidad
                            </small>
                        </div>
                    </div>

                    <div class="import-card mb-4">
                        <div class="import-card-header">
                            <div class="import-card-icon bg-gradient-green">
                                <i class="bi bi-file-earmark-arrow-up-fill"></i>
                            </div>
                            <h5 class="mb-0">Archivo CSV</h5>
                        </div>
                        <div class="import-card-body">
                            <label for="csvFile" class="file-upload-zone">
                                <div class="upload-icon-container">
                                    <i class="bi bi-cloud-arrow-up-fill"></i>
                                </div>
                                <div class="upload-text">
                                    <p class="upload-title">Arrastrá tu archivo CSV aquí</p>
                                    <p class="upload-subtitle">o hacé clic para seleccionarlo</p>
                                </div>
                                <div class="upload-requirements">
                                    <span class="requirement-item">
                                        <i class="bi bi-check-circle-fill me-1"></i>Formato: .csv
                                    </span>
                                    <span class="requirement-item">
                                        <i class="bi bi-check-circle-fill me-1"></i>Separador: coma (,)
                                    </span>
                                </div>
                                <input type="file" id="csvFile" name="file" accept=".csv" required>
                            </label>

                            <div id="fileNameDisplay" class="selected-file-display"></div>
                        </div>
                    </div>

                    <div class="info-panel mb-4">
                        <div class="info-panel-header">
                            <i class="bi bi-lightbulb-fill me-2"></i>
                            <h6 class="mb-0">Formato del CSV</h6>
                        </div>
                        <div class="info-panel-body">
                            <p class="mb-2">Tomaremos en cuenta estas columnas de tu archivo CSV:</p>
                            <div class="csv-columns">
                                <span class="csv-column">titulo</span>
                                <span class="csv-column">descripcion</span>
                                <span class="csv-column">categoria</span>
                                <span class="csv-column">latitud</span>
                                <span class="csv-column">longitud</span>
                                <span class="csv-column">fecha del hecho</span>
                                <span class="csv-column">pais</span>
                                <span class="csv-column">provincia</span>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1"></i>Asegurate de que la primera fila contenga los nombres de las columnas
                            </small>
                        </div>
                    </div>

                    <div class="action-buttons-import">
                        <a href="javascript:history.back()" class="btn btn-secondary-import">
                            <i class="bi bi-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary-import" id="uploadButton" disabled>
                            <i class="bi bi-cloud-upload me-2"></i>Importar archivo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .contribute-badge{background:linear-gradient(135deg,rgba(79,70,229,.12),rgba(129,140,248,.12));color:#4f46e5;padding:.6rem 1.5rem;border-radius:999px;font-size:.85rem;font-weight:600;display:inline-flex;align-items:center;gap:.4rem;border:1px solid rgba(79,70,229,.22)}
        .import-hero{padding:80px 0 40px;background:radial-gradient(ellipse 1400px 800px at 50% -100px,rgba(102,126,234,.12) 0%,transparent 50%);position:relative;overflow:hidden}
        .import-hero::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236b5cff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");pointer-events:none}
        .import-badge{background:linear-gradient(135deg,rgba(59,130,246,.15),rgba(37,99,235,.15));color:#2563eb;padding:.65rem 1.5rem;border-radius:50px;font-size:.875rem;font-weight:600;display:inline-flex;align-items:center;border:1px solid rgba(37,99,235,.2)}
        .import-card{background:#fff;border-radius:20px;border:1px solid rgba(0,0,0,.06);box-shadow:0 4px 12px rgba(0,0,0,.05);overflow:hidden}
        .import-card-header{padding:1.5rem;background:linear-gradient(135deg,#f8f9ff 0%,#fff 100%);border-bottom:1px solid rgba(0,0,0,.05);display:flex;align-items:center;gap:1rem}
        .import-card-icon{width:48px;height:48px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;box-shadow:0 4px 12px rgba(102,126,234,.3)}
        .import-card-icon.bg-gradient-green{background:linear-gradient(135deg,#10b981,#059669)}
        .import-card-body{padding:2rem}
        .form-label-import{display:flex;align-items:center;font-size:.9rem;font-weight:600;color:#475569;margin-bottom:.75rem}
        .form-control-import{background:#f8f9ff;border:1px solid #e9ecef;border-radius:12px;padding:.875rem 1rem;font-size:.9rem;color:#1a202c;transition:all .2s ease;width:100%}
        .form-control-import:focus{border-color:#667eea;background:#fff;box-shadow:0 0 0 .2rem rgba(102,126,234,.1);outline:none}
        .form-control-import::placeholder{color:#94a3b8}
        .form-text-import{display:block;margin-top:.5rem;font-size:.8rem;color:#64748b}
        .file-upload-zone{display:block;border:3px dashed #cbd5e1;border-radius:16px;padding:3rem 2rem;cursor:pointer;transition:all .3s ease;background:linear-gradient(135deg,#f8f9ff 0%,#fff 100%);position:relative;overflow:hidden}
        .file-upload-zone::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(102,126,234,.03),rgba(16,185,129,.03));opacity:0;transition:opacity .3s ease}
        .file-upload-zone:hover{border-color:#667eea;background:#fff}
        .file-upload-zone:hover::before{opacity:1}
        .file-upload-zone input[type="file"]{display:none}
        .upload-icon-container{width:80px;height:80px;margin:0 auto 1.5rem;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(102,126,234,.3);transition:transform .3s ease}
        .file-upload-zone:hover .upload-icon-container{transform:scale(1.1)}
        .upload-icon-container i{font-size:2.5rem;color:#fff}
        .upload-text{text-align:center;margin-bottom:1.5rem}
        .upload-title{font-size:1.25rem;font-weight:700;color:#1a202c;margin:0 0 .5rem}
        .upload-subtitle{font-size:.95rem;color:#64748b;margin:0}
        .upload-requirements{display:flex;justify-content:center;gap:2rem;flex-wrap:wrap}
        .requirement-item{display:inline-flex;align-items:center;font-size:.85rem;color:#059669;font-weight:600;background:rgba(5,150,105,.1);padding:.5rem 1rem;border-radius:8px}
        .requirement-item i{font-size:1rem}
        .selected-file-display{margin-top:1.5rem;padding:1rem 1.5rem;background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(5,150,105,.1));border:1px solid rgba(5,150,105,.2);border-radius:12px;color:#047857;font-weight:600;display:none}
        .selected-file-display.active{display:block}
        .selected-file-display i{margin-right:.5rem;font-size:1.25rem}
        .info-panel{background:#fff;border:1px solid rgba(245,158,11,.2);border-left:4px solid #f59e0b;border-radius:16px;overflow:hidden}
        .info-panel-header{padding:1rem 1.5rem;background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.05));display:flex;align-items:center;color:#92400e;font-weight:700;border-bottom:1px solid rgba(245,158,11,.15)}
        .info-panel-body{padding:1.5rem}
        .csv-columns{display:flex;flex-wrap:wrap;gap:.75rem;margin-top:1rem}
        .csv-column{background:#f8f9ff;border:1px solid #e9ecef;padding:.5rem 1rem;border-radius:8px;font-family:monospace;font-size:.85rem;color:#667eea;font-weight:600}
        .action-buttons-import{display:flex;gap:1rem;justify-content:flex-end;flex-wrap:wrap}
        .btn-primary-import{background:linear-gradient(135deg,#10b981,#059669);border:none;color:#fff;padding:.875rem 2rem;border-radius:12px;font-weight:600;box-shadow:0 4px 12px rgba(16,185,129,.3);transition:all .2s ease;display:inline-flex;align-items:center}
        .btn-primary-import:hover:not(:disabled){background:linear-gradient(135deg,#059669,#047857);transform:translateY(-2px);box-shadow:0 6px 16px rgba(16,185,129,.4);color:#fff}
        .btn-primary-import:disabled{background:#d1d5db;color:#9ca3af;cursor:not-allowed;box-shadow:none}
        .btn-secondary-import{background:#fff;border:2px solid #e9ecef;color:#64748b;padding:.875rem 2rem;border-radius:12px;font-weight:600;transition:all .2s ease;display:inline-flex;align-items:center;text-decoration:none}
        .btn-secondary-import:hover{border-color:#667eea;color:#667eea;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.15)}
        @media (max-width:768px){
            .import-hero{padding:60px 0 30px}
            .display-5{font-size:2rem}
            .import-card-body{padding:1.5rem}
            .file-upload-zone{padding:2rem 1.5rem}
            .upload-icon-container{width:64px;height:64px}
            .upload-icon-container i{font-size:2rem}
            .upload-requirements{gap:1rem}
            .action-buttons-import{justify-content:stretch}
            .action-buttons-import a,.action-buttons-import button{flex:1}
        }
    </style>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('csvFile');
            const inputFuente = document.getElementById('inputFuente');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const uploadButton = document.getElementById('uploadButton');
            const fileUploadZone = document.querySelector('.file-upload-zone');
            const importForm = document.getElementById('importForm');

            const validateForm = () => {
                const isFileSelected = fileInput.files.length > 0 && fileInput.files[0].name.toLowerCase().endsWith('.csv');
                const isFuenteFilled = inputFuente.value.trim().length > 0;
                uploadButton.disabled = !(isFileSelected && isFuenteFilled);
            };

            fileInput.addEventListener('change', function() {
                if (fileInput.files.length > 0 && fileInput.files[0].name.toLowerCase().endsWith('.csv')) {
                    fileNameDisplay.innerHTML = `<i class="bi bi-file-earmark-check-fill"></i>Archivo: ${fileInput.files[0].name}`;
                    fileNameDisplay.classList.add('active');
                } else {
                    showError('Error: Solo se permiten archivos .csv');
                    fileInput.value = "";
                }
                validateForm();
            });

            inputFuente.addEventListener('input', validateForm);

            fileUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadZone.style.borderColor = '#10b981';
                fileUploadZone.style.background = '#fff';
            });

            fileUploadZone.addEventListener('dragleave', () => {
                fileUploadZone.style.borderColor = '#cbd5e1';
                fileUploadZone.style.background = 'linear-gradient(135deg,#f8f9ff 0%,#fff 100%)';
            });

            fileUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadZone.style.borderColor = '#cbd5e1';
                fileUploadZone.style.background = 'linear-gradient(135deg,#f8f9ff 0%,#fff 100%)';

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
                    fileInput.files = files;
                    fileNameDisplay.innerHTML = `<i class="bi bi-file-earmark-check-fill"></i>Archivo: ${files[0].name}`;
                    fileNameDisplay.classList.add('active');
                } else {
                    showError('Error: Por favor, suelta un archivo .csv válido');
                    fileInput.value = "";
                }
                validateForm();
            });

            function showError(msg) {
                fileNameDisplay.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i>${msg}`;
                fileNameDisplay.style.background = 'linear-gradient(135deg,rgba(220,38,38,.1),rgba(185,28,28,.1))';
                fileNameDisplay.style.borderColor = 'rgba(220,38,38,.2)';
                fileNameDisplay.style.color = '#991b1b';
                fileNameDisplay.classList.add('active');
                setTimeout(() => {
                    fileNameDisplay.classList.remove('active');
                    fileNameDisplay.style.background = '';
                    fileNameDisplay.style.borderColor = '';
                    fileNameDisplay.style.color = '';
                }, 3000);
            }

            importForm.addEventListener('submit', function(e) {

                uploadButton.disabled = true;
                uploadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Importando...';

                if (!inputFuente.name) {
                    inputFuente.name = 'fuenteString';
                }

                if (!importForm.querySelector('input[name="_csrf"]')) {
                    const csrfMeta = document.querySelector("meta[name='_csrf']");
                    if (csrfMeta) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = '_csrf';
                        csrfInput.value = csrfMeta.getAttribute("content");
                        importForm.appendChild(csrfInput);
                    }
                }

            });
        });
    </script>
</main>