<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<main th:fragment="contenido" class="container py-4">

    <!-- Encabezado -->
    <section class="text-center py-4"
             style="background: radial-gradient(1200px 600px at 50% -150px, #e8ecf6 0%, #f7f9fb 100%);
                  border-radius:12px;">
        <h2 class="fw-bold mb-1"><i class="bi bi-plus-circle me-2"></i>Contribuir con un nuevo hecho</h2>
        <p class="text-muted mb-0">Completá la información del evento histórico que querés proponer</p>
    </section>

    <!-- Mini-form GET para recargar provincias sin perder datos -->
    <form id="filtroPaisForm" th:action="@{/public/contribuir}" method="get" style="display:none;">
        <input type="hidden" name="titulo">
        <input type="hidden" name="descripcion">
        <input type="hidden" name="fechaAcontecimiento">
        <input type="hidden" name="latitud">
        <input type="hidden" name="longitud">
        <input type="hidden" name="id_categoria">
        <input type="hidden" name="id_provincia">
        <input type="hidden" name="id_pais" id="filtroPaisInput">
    </form>

    <!-- Form principal -->
    <form id="formPost" th:action="@{/solicitudes-hecho/public/subir-hecho}" method="post"
          th:object="${solicitudHecho}" enctype="multipart/form-data" class="mt-4">

        <!-- CSRF -->
        <input type="hidden" th:if="${_csrf != null}"
               th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Información básica -->
        <div class="card mb-4 border-0 shadow-sm" style="border-radius:14px;">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información básica</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Título del hecho *</label>
                        <input class="form-control" th:field="*{titulo}" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Categoría *</label>
                        <select class="form-select" th:field="*{id_categoria}" required>
                            <option value="">Seleccionar categoría</option>
                            <option th:each="cat : ${categorias}"
                                    th:value="${cat.id}"
                                    th:text="${cat.categoria}"></option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-semibold">Descripción *</label>
                        <textarea class="form-control" rows="4" th:field="*{descripcion}"
                                  placeholder="Describe el evento histórico de manera clara y concisa..."
                                  required></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ubicación y fecha -->
        <div class="card mb-4 border-0 shadow-sm" style="border-radius:14px;">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Ubicación y fecha</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">

                    <!-- País (select) -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">País *</label>
                        <select id="selectPais" class="form-select" th:field="*{id_pais}" required
                                th:attr="data-pais-id=${pais != null} ? ${pais.id} : null"
                                onchange="
                      const post = document.getElementById('formPost');
                      const getF = document.getElementById('filtroPaisForm');

                      // Copiar campos actuales al mini-GET (incluye lat/long)
                      ['titulo','descripcion','fechaAcontecimiento','latitud','longitud','id_categoria','id_provincia']
                        .forEach(n => {
                          const src = post.querySelector(`[name='${n}']`);
                          const dst = getF.querySelector(`[name='${n}']`);
                          if (src && dst) dst.value = src.value ?? '';
                        });

                      // Setear país nuevo y limpiar provincia (para recargar lista)
                      getF.querySelector('[name=id_pais]').value = this.value;
                      getF.querySelector('[name=id_provincia]').value = '';

                      getF.submit();
                    ">
                            <option value="">Seleccionar país</option>
                            <option th:each="paisItem : ${paises}"
                                    th:value="${paisItem.id}"
                                    th:text="${paisItem.pais}"></option>
                        </select>
                    </div>

                    <!-- Provincia (select) -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Provincia / Estado (opcional)</label>
                        <select id="selectProvincia" class="form-select" th:field="*{id_provincia}"
                                th:attr="disabled=${solicitudHecho.id_pais == null}"
                                th:attrappend=" data-prov-id=${provincia != null} ? ${provincia.id} : null">
                            <option value="">Seleccionar provincia/estado</option>
                            <option th:each="prov : ${provincias}"
                                    th:value="${prov.id}"
                                    th:text="${prov.provincia}"></option>
                        </select>
                    </div>

                    <!-- Fecha -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Fecha del acontecimiento *</label>
                        <input type="date" class="form-control" th:field="*{fechaAcontecimiento}" required>
                    </div>

                    <!-- Latitud / Longitud -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Latitud / Longitud (opcional)</label>
                        <div class="input-group">
                            <input type="number" step="any" class="form-control"
                                   th:field="*{latitud}" placeholder="-34.6037">
                            <input type="number" step="any" class="form-control"
                                   th:field="*{longitud}" placeholder="-58.3816">
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="d-flex justify-content-between mt-4">
            <a th:href="@{/}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-dark" sec:authorize="!hasRole('ADMINISTRADOR')">
                <i class="bi bi-send me-1"></i> Enviar solicitud
            </button>
            <button type="submit" class="btn btn-dark" sec:authorize="hasRole('ADMINISTRADOR')" th:formaction="@{/hechos/subir}">
                <i class="bi bi-send me-1"></i> Subir Hecho
            </button>
        </div>
    </form>

    <style>.btn:hover{transform:translateY(-1px);transition:transform .08s ease}</style>

    <!-- Auto-preselección País/Provincia detectados -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selPais = document.getElementById('selectPais');
            const selProv = document.getElementById('selectProvincia');

            const detectedPaisId = selPais?.dataset?.paisId || '';
            const detectedProvId = selProv?.dataset?.provId || '';

            // Si el backend detectó país y todavía no lo tenemos seleccionado ni cargadas las provincias,
            // hacemos un GET automático para recargar con id_pais (preservando campos).
            if (detectedPaisId && !selPais.value) {
                const post = document.getElementById('formPost');
                const getF  = document.getElementById('filtroPaisForm');
                ['titulo','descripcion','fechaAcontecimiento','latitud','longitud','id_categoria','id_provincia']
                    .forEach(n => {
                        const src = post.querySelector(`[name='${n}']`);
                        const dst = getF.querySelector(`[name='${n}']`);
                        if (src && dst) dst.value = src.value ?? '';
                    });
                getF.querySelector('[name=id_pais]').value = detectedPaisId;
                getF.submit();
                return; // dejamos que recargue
            }

            // Si ya hay lista de provincias cargada, preseleccionamos la detectada
            if (detectedPaisId && selPais && !selPais.value) {
                selPais.value = detectedPaisId;
            }
            if (detectedProvId && selProv) {
                selProv.value = detectedProvId;
            }
        });
    </script>

</main>
</html>
